#!/usr/bin/env bash

set -e -o pipefail

BACKUP_NAME=$(~/bin/backup_name)
HOME="/home/grb"
TARSNAP="/usr/local/bin/tarsnap"
CACHE="$HOME/.tarsnap/cache"
KEY="$HOME/.tarsnap/tarsnap.key"
PACKAGE_MANIFEST="$HOME/log/packages.txt"
SOURCE="$HOME"
LOG="$HOME/log/backup.log"

sync_package_list() {
    echo "=== BEGIN PACKAGE SYNC $BACKUP_NAME"
    dpkg -l > "$PACKAGE_MANIFEST"
    echo "Packages dumped: $(wc -l $PACKAGE_MANIFEST)"
    echo "=== END PACKAGE SYNC $BACKUP_NAME"
}

tarsnap_backup() {
    echo "=== BEGIN TARSNAP BACKUP $BACKUP_NAME"
    $TARSNAP \
        --cachedir "$CACHE" \
        --keyfile "$KEY" \
        -cf "$BACKUP_NAME" \
        --print-stats \
        -X <(~/bin/backup_exclude | sed 's/^/\/home\/grb/') \
        $EXCLUDE \
        $SOURCE
    echo "=== END TARSNAP BACKUP $BACKUP_NAME"
}

ssh_backup() {
    echo "=== BEGIN SSH BACKUP $BACKUP_NAME"
    ~/bin/ssh_backup "$BACKUP_NAME"
    echo "=== END SSH BACKUP $BACKUP_NAME"
}

s3ql_backup() {
    echo "=== BEGIN S3QL BACKUP $BACKUP_NAME"
    ~/bin/s3ql_backup "$BACKUP_NAME"
    echo "=== END S3QL BACKUP $BACKUP_NAME"
}

main() {
    sync_package_list
    time tarsnap_backup
    time ssh_backup
    time s3ql_backup
}

main &>> $LOG
